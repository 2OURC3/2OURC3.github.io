<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>2. Hide junk script</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>2. Hide junk script</h1><br/>Hardening techniques :  Junk code inside ASM to make the read harder for human.<br />Counter-measure : Create a script to hide the Junk code<br /><br /><br />################################################################################<br />##<br />## Junk Hide for PYKSPA<br />##<br />## Author: @herrcore<br />##<br />## Hide junk code:<br />##  mov al &lt;something&gt;<br />##  mov al &lt;something&gt;<br />##  mov al &lt;something&gt;<br />##  mov al &lt;something&gt;<br />##<br />##<br />## Original idea and code from:<br />## <a href="https://gist.github.com/dperezmavro/e778ba259cc91f315eed">https://gist.github.com/dperezmavro/e778ba259cc91f315eed</a><br />## <br />################################################################################<br /><br />import idautils <br />import idc <br /><br />hides = []<br />in_junk = 0 <br />curr_pos = 0 <br />junk_len = 0 <br /><br />for seg_ea in idautils.Segments():<br />    for head in idautils.Heads(seg_ea, idc.SegEnd(seg_ea)):<br />        if idc.isCode(idc.GetFlags(head)):        <br />            mnem = idc.GetMnem(head)<br />            end_junk = False<br />            if mnem == &#39;mov&#39;:<br />                op1 = idc.GetOpnd(head, 0)<br />                if op1 == &#39;al&#39;:<br />                    junk_len += 1<br />                    if in_junk == 0:<br />                        curr_pos = head<br />                        in_junk = 1<br />                else:<br />                    end_junk = True<br />            else :<br />                end_junk = True<br />            if end_junk:<br />                if in_junk == 1 :<br />                    in_junk = 0<br />                    if junk_len &gt; 4:<br />                        len_junk_block = 2 * junk_len<br />                        hides.append([curr_pos,len_junk_block])<br />                    curr_pos = 0 <br />                    junk_len = 0 <br /><br />for h in hides:<br />    print &quot;hiding 0x%x - 0x%x&quot; % (h[0], h[0]+h[1])<br />    if h[1] &gt; 1:<br />        idc.DelHiddenArea(h[0])<br />        idc.HideArea(h[0],h[0]+h[1],&#39;&#39;,&#39;&#39;,&#39;&#39;,0xEEFFFF)</div></body></html>